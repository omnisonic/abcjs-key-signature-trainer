<!DOCTYPE html>
<html>
<head>
    <title>Key Signature Trainer</title>
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.0.0/dist/abcjs-basic-min.js"></script>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        #staff {
            transform: scale(1.5);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px;
        }
        #staff svg {
            margin: 0 auto;
        }
        #answer {
            min-height: 30px;
        }
        .exercise-selector {
            margin-bottom: 20px;
        }
        .key-selector {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 600px;
        }
        .key-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .key-checkbox input {
            margin: 0;
        }
    </style>
    <script>
        const keys = [
            {name: 'C Major / A minor', accidental: '', num: 0, rootNote: 'C'},
            {name: 'G Major / E minor', accidental: '#', num: 1, rootNote: 'G'},
            {name: 'D Major / B minor', accidental: '#', num: 2, rootNote: 'D'},
            {name: 'A Major / F# minor', accidental: '#', num: 3, rootNote: 'A'},
            {name: 'E Major / C# minor', accidental: '#', num: 4, rootNote: 'E'},
            {name: 'B Major / G# minor', accidental: '#', num: 5, rootNote: 'B'},
            {name: 'F# Major / D# minor', accidental: '#', num: 6, rootNote: 'F#'},
            {name: 'Db Major / Bb minor', accidental: 'b', num: 5, rootNote: 'Db'}
        ];

        const solfegeSeries = ['do', 're', 'mi', 'fa', 'sol', 'la', 'ti'];
        const noteSequence = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
        
        let currentKeyIndex = 0;
        let cycleInterval;
        let currentExercise = 'key-signature';
        let selectedKeyIndices = [0, 1, 2, 3, 4, 5, 6, 7]; // All keys selected by default
        
        function getMovableDo(key, note) {
            const rootIndex = noteSequence.indexOf(key.rootNote);
            const noteIndex = noteSequence.indexOf(note);
            const relativeSolfegeIndex = (noteIndex - rootIndex + 7) % 7;
            return solfegeSeries[relativeSolfegeIndex];
        }
        
        function generateExercise() {
            const key = keys[currentKeyIndex];
            let staff, note;

            if (currentExercise === 'key-signature') {
                staff = `X:1\nK:${key.name}\nL:1/4\n|:`;
                note = '';
            } else {
                // Generate a random note
                const randomNoteIndex = Math.floor(Math.random() * noteSequence.length);
                const randomNote = noteSequence[randomNoteIndex];
                const solfege = getMovableDo(key, randomNote);
                
                staff = `X:1\nK:${key.name}\nL:1/4\n[${randomNote}]`;
                note = solfege;
            }
            
            // Clear previous rendering
            document.getElementById("staff").innerHTML = '';
            document.getElementById("answer").textContent = '';
            
            // Render staff
            ABCJS.renderAbc("staff", staff);
            
            // Set timeout to reveal answer
            setTimeout(() => {
                const answerText = currentExercise === 'key-signature' 
                    ? `Key: ${key.name}` 
                    : `Note: ${note} (${note === 'do' ? 'root' : 'relative to do'})`;
                document.getElementById("answer").textContent = answerText;
            }, 5000);
            
            // Move to next selected key
            currentKeyIndex = getNextSelectedKeyIndex();
        }
        
        function changeExercise() {
            currentExercise = document.querySelector('input[name="exercise"]:checked').value;
            generateExercise();
        }
        
        function toggleKey(index) {
            const checkbox = document.getElementById(`key-${index}`);
            if (checkbox.checked) {
                // Add key if not already selected
                if (!selectedKeyIndices.includes(index)) {
                    selectedKeyIndices.push(index);
                    selectedKeyIndices.sort((a, b) => a - b);
                }
            } else {
                // Remove key from selection
                selectedKeyIndices = selectedKeyIndices.filter(i => i !== index);
            }
            
            // Update "All Keys" checkbox
            updateAllKeysCheckbox();
            
            // If current key is no longer selected, move to next selected key
            if (!selectedKeyIndices.includes(currentKeyIndex)) {
                moveToNextSelectedKey();
            }
        }
        
        function toggleAllKeys() {
            const allCheckbox = document.getElementById('key-all');
            const allSelected = allCheckbox.checked;
            
            // Update all individual key checkboxes
            keys.forEach((key, index) => {
                const checkbox = document.getElementById(`key-${index}`);
                checkbox.checked = allSelected;
            });
            
            // Update selected key indices
            if (allSelected) {
                selectedKeyIndices = keys.map((_, index) => index);
            } else {
                selectedKeyIndices = [];
            }
            
            // If no keys are selected, we need to handle this case
            if (selectedKeyIndices.length === 0) {
                document.getElementById("staff").innerHTML = '<p>Please select at least one key to practice</p>';
                document.getElementById("answer").textContent = '';
                clearInterval(cycleInterval);
            } else {
                // Make sure current key is selected
                if (!selectedKeyIndices.includes(currentKeyIndex)) {
                    moveToNextSelectedKey();
                }
                // Restart interval if it was cleared
                if (!cycleInterval) {
                    cycleInterval = setInterval(generateExercise, 6000);
                }
            }
        }
        
        function updateAllKeysCheckbox() {
            const allCheckbox = document.getElementById('key-all');
            const allSelected = selectedKeyIndices.length === keys.length;
            allCheckbox.checked = allSelected;
        }
        
        function moveToNextSelectedKey() {
            if (selectedKeyIndices.length === 0) return;
            
            // Find the next selected key index
            let nextIndex = selectedKeyIndices.findIndex(idx => idx > currentKeyIndex);
            if (nextIndex === -1) {
                // Wrap around to first selected key
                currentKeyIndex = selectedKeyIndices[0];
            } else {
                currentKeyIndex = selectedKeyIndices[nextIndex];
            }
        }
        
        function getNextSelectedKeyIndex() {
            if (selectedKeyIndices.length === 0) return 0;
            
            // Find current position in selected keys
            const currentPos = selectedKeyIndices.indexOf(currentKeyIndex);
            if (currentPos === -1) {
                // Current key not selected, return first selected key
                return selectedKeyIndices[0];
            }
            
            // Move to next selected key, wrap around if at end
            const nextPos = (currentPos + 1) % selectedKeyIndices.length;
            return selectedKeyIndices[nextPos];
        }
        
        // Start cycling through keys automatically when page loads
        window.onload = function() {
            generateExercise(); // Initial exercise
            cycleInterval = setInterval(generateExercise, 6000); // 5s display + 1s buffer
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="exercise-selector">
            <label>
                <input type="radio" name="exercise" value="key-signature" checked onchange="changeExercise()">
                Key Signature
            </label>
            <label>
                <input type="radio" name="exercise" value="note" onchange="changeExercise()">
                Note
            </label>
        </div>
        <div class="key-selector">
            <div class="key-checkbox">
                <input type="checkbox" id="key-all" checked onchange="toggleAllKeys()">
                <label for="key-all">All Keys</label>
            </div>
            <div class="key-checkbox">
                <input type="checkbox" id="key-0" checked onchange="toggleKey(0)">
                <label for="key-0">C Major / A minor</label>
            </div>
            <div class="key-checkbox">
                <input type="checkbox" id="key-1" checked onchange="toggleKey(1)">
                <label for="key-1">G Major / E minor</label>
            </div>
            <div class="key-checkbox">
                <input type="checkbox" id="key-2" checked onchange="toggleKey(2)">
                <label for="key-2">D Major / B minor</label>
            </div>
            <div class="key-checkbox">
                <input type="checkbox" id="key-3" checked onchange="toggleKey(3)">
                <label for="key-3">A Major / F# minor</label>
            </div>
            <div class="key-checkbox">
                <input type="checkbox" id="key-4" checked onchange="toggleKey(4)">
                <label for="key-4">E Major / C# minor</label>
            </div>
            <div class="key-checkbox">
                <input type="checkbox" id="key-5" checked onchange="toggleKey(5)">
                <label for="key-5">B Major / G# minor</label>
            </div>
            <div class="key-checkbox">
                <input type="checkbox" id="key-6" checked onchange="toggleKey(6)">
                <label for="key-6">F# Major / D# minor</label>
            </div>
            <div class="key-checkbox">
                <input type="checkbox" id="key-7" checked onchange="toggleKey(7)">
                <label for="key-7">Db Major / Bb minor</label>
            </div>
        </div>
        <h1>Key Signature Trainer</h1>
        <div id="staff"></div>
        <div id="answer"></div>
    </div>
</body>
</html>
